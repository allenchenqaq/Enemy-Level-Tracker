<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Team Tracker</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Panel -->
  <div class="game-panel">
    <div class="panel-title">Team Tracker</div>
    <div class="subtitle" id="subtitle">CHAOS Team • Level ≥ 6</div>

    <!-- Content -->
    <div id="teamContainer" class="loading">Waiting for data…</div>
  </div>

  <script>
    // Keep prior state for level-up toasts
    const previousBySummoner = Object.create(null);

    function showToast(playerName, level) {
      const container = document.getElementById("toastContainer");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `
        <div class="toast-icon">⬆️</div>
        <div class="toast-content">
          <div class="toast-title">Level Up!</div>
          <div class="toast-message">${playerName} is level ${level} now</div>
        </div>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 2800);
    }

    // Called from main.js on every poll
    // rows = [{ Champion, Level, Dead, Position, Summoner, Team }]
    // gameTime = "mm:ss"
    window.updateTable = function (rows, gameTime) {
      const container = document.getElementById("teamContainer");
      container.classList.remove("loading");
      container.innerHTML = "";

      // Header line with time
      const time = document.createElement("div");
      time.className = "game-time";
      time.textContent = `⏱️ Game Time ${gameTime || "--:--"}`;
      container.appendChild(time);

      if (!rows || rows.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "No CHAOS players above level 6 yet.";
        container.appendChild(empty);
        return;
      }

      // Render each player row
      rows.forEach((p, idx) => {
        // toast if the same Summoner leveled up
        const prev = previousBySummoner[p.Summoner];
        if (prev && Number(prev.Level) < Number(p.Level)) {
          showToast(p.Champion ?? "Player", p.Level ?? "?");
        }

        const row = document.createElement("div");
        row.className = "teammate-row";

        const info = document.createElement("div");
        info.className = "teammate-info"; // no-drag in CSS

        const avatarWrap = document.createElement("div");
        avatarWrap.className = "avatar-container";

        const avatar = document.createElement("div");
        avatar.className = `avatar avatar-${(idx % 4) + 1}`;
        avatar.textContent = (p.Champion || "?").charAt(0).toUpperCase();

        const badge = document.createElement("div");
        badge.className = "level-badge";
        badge.textContent = String(p.Level ?? "-");

        const name = document.createElement("div");
        name.className = "teammate-name";
        name.textContent = `${p.Champion ?? "Unknown"} • ${p.Position ?? "NONE"}`;

        const meta = document.createElement("div");
        meta.className = "teammate-meta";
        meta.textContent = (p.Dead === "no") ? "Alive" : `Dead ${String(p.Dead || "").replace("yes ", "")}`;

        avatarWrap.appendChild(avatar);
        avatarWrap.appendChild(badge);

        const infoText = document.createElement("div");
        infoText.className = "teammate-text";
        infoText.appendChild(name);
        infoText.appendChild(meta);

        info.appendChild(avatarWrap);
        info.appendChild(infoText);

        row.appendChild(info);
        container.appendChild(row);

        // store latest snapshot for toasts
        previousBySummoner[p.Summoner] = p;
      });
    };

    // Called from main.js when a poll fails
    window.showError = function (message) {
      const container = document.getElementById("teamContainer");
      container.innerHTML = `<div class="error">Error: ${message}</div>`;
    };
  </script>
</body>
</html>
